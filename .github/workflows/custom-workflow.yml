name: Custom Workflow - Release & Metrics

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release-notes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Generate release notes
      run: |
        echo "ðŸ“ Generating release notes..."
        
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")
        
        echo "## ðŸš€ Release $LATEST_TAG" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "**Date:** $(date '+%Y-%m-%d')" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### Changes since $PREVIOUS_TAG:" >> RELEASE_NOTES.md
          git log $PREVIOUS_TAG..$LATEST_TAG --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
        else
          echo "### Initial Release" >> RELEASE_NOTES.md
          git log --pretty=format:"- %s (%h)" | head -10 >> RELEASE_NOTES.md
        fi
        
        echo "" >> RELEASE_NOTES.md
        cat RELEASE_NOTES.md
        
    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: RELEASE_NOTES.md
        
  metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Collect project metrics
      run: |
        echo "ðŸ“Š Collecting metrics..."
        
        echo "## Project Metrics" > METRICS.md
        echo "" >> METRICS.md
        echo "**Generated:** $(date)" >> METRICS.md
        echo "" >> METRICS.md
        
        echo "### Repository Stats" >> METRICS.md
        echo "- **Commits:** $(git rev-list --count HEAD)" >> METRICS.md
        echo "- **Contributors:** $(git log --format='%aN' | sort -u | wc -l)" >> METRICS.md
        echo "- **Files:** $(find . -type f -not -path '*/\.git/*' -not -path '*/node_modules/*' | wc -l)" >> METRICS.md
        echo "- **JavaScript Files:** $(find . -name '*.js' -not -path '*/node_modules/*' | wc -l)" >> METRICS.md
        echo "" >> METRICS.md
        
        echo "### Recent Activity" >> METRICS.md
        echo "- **Last Commit:** $(git log -1 --format='%ar')" >> METRICS.md
        echo "- **Branch:** $(git branch --show-current)" >> METRICS.md
        
        cat METRICS.md
        
    - name: Upload metrics
      uses: actions/upload-artifact@v4
      with:
        name: project-metrics
        path: METRICS.md
